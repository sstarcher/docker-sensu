{
  "Conditions": {
    "ArgosSimulateTrue": {
      "Fn::Equals": [
        {
          "Ref": "ArgosLive"
        },
        "false"
      ]
    },
    "IsDevEnv": {
      "Fn::Equals": [
        {
          "Ref": "ApplicationEnv"
        },
        "dev"
      ]
    }
  },
  "Description": "AWS CloudFormation Template for ECS Sensu",
  "Outputs": {
    "ContainerName": {
      "Description": "Container Name",
      "Value": {
        "Ref": "ContainerName"
      }
    },
    "ContainerServiceArn": {
      "Description": "Container Service ARN",
      "Value": {
        "Ref": "ContainerService"
      }
    },
    "ContainerTaskdefinitionArn": {
      "Description": "Container TaskDefinition ARN",
      "Value": {
        "Ref": "ContainerTaskdefinition"
      }
    }
  },
  "Parameters": {
    "ApplicationEnv": {
      "Default": "SSM_BASE_PATH/ECS/application_env",
      "Description": "Application Environment DEV | PROD",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ArgosLive": {
      "Default": "SSM_BASE_PATH/ECS/argos_live",
      "Description": "false | true for argos setting",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "BuildImageTag": {
      "Default": "SSM_BASE_PATH/ECS/build_image_tag",
      "Description": "Build Image Commit Tag",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerAdjustmentNumberHighDown": {
      "Default": "SSM_BASE_PATH/ECS/container_adjustment_number_high_down",
      "Description": "The amount by which to scale.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerAdjustmentNumberHighUp": {
      "Default": "SSM_BASE_PATH/ECS/container_adjustment_number_high_up",
      "Description": "The amount by which to scale.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerAdjustmentNumberLowDown": {
      "Default": "SSM_BASE_PATH/ECS/container_adjustment_number_low_down",
      "Description": "The amount by which to scale.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerAdjustmentNumberLowUp": {
      "Default": "SSM_BASE_PATH/ECS/container_adjustment_number_low_up",
      "Description": "The amount by which to scale.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerAlarmEvaluationPeriod": {
      "Default": "SSM_BASE_PATH/ECS/container_alarm_evaluation_period",
      "Description": "The number of periods over which data is compared to the specified threshold.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerAlarmPeriod": {
      "Default": "SSM_BASE_PATH/ECS/container_alarm_period",
      "Description": "The time over which the specified statistic is applied.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerAlarmTresholdDown": {
      "Default": "SSM_BASE_PATH/ECS/container_alarm_treshold_down",
      "Description": "The value against which the specified statistic is compared.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerAlarmTresholdUp": {
      "Default": "SSM_BASE_PATH/ECS/container_alarm_treshold_up",
      "Description": "The value against which the specified statistic is compared.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerAutoscalingRole": {
      "Default": "SSM_BASE_PATH/ECS/container_autoscaling_role",
      "Description": "Container autoscaling role (ARN)",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerCooldown": {
      "Default": "SSM_BASE_PATH/ECS/container_cooldown",
      "Description": "The amount of time, in seconds, after a scaling activity completes before any further trigger-related scaling activities can start.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerCpu": {
      "Default": "SSM_BASE_PATH/ECS/container_cpu",
      "Description": "ECS Service CPU usage",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerDesiredCount": {
      "Default": "SSM_BASE_PATH/ECS/container_desired_count",
      "Description": "The scalable dimension thatÂ´s associated with the scalable target.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerHost": {
      "Default": "SSM_BASE_PATH/ECS/container_host",
      "Description": "Container Host",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerImage": {
      "Description": "ECS image repository",
      "Type": "String"
    },
    "ContainerMaxCapacity": {
      "Default": "SSM_BASE_PATH/ECS/container_max_capacity",
      "Description": "The maximum value that Application Auto Scaling can use to scale a target during a scaling activity.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerMemory": {
      "Default": "SSM_BASE_PATH/ECS/container_memory",
      "Description": "ECS Service Memory usage",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerMemoryReservation": {
      "Default": "SSM_BASE_PATH/ECS/container_memory_reservation",
      "Description": "ECS Service Memory reservation usage",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerMetricIntervalLowerBoundDown": {
      "Default": "SSM_BASE_PATH/ECS/container_metric_interval_lower_bound_down",
      "Description": "The lower bound of the breach size",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerMetricIntervalLowerBoundUp": {
      "Default": "SSM_BASE_PATH/ECS/container_metric_interval_lower_bound_up",
      "Description": "The lower bound of the breach size",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerMetricIntervalUpperBoundDown": {
      "Default": "SSM_BASE_PATH/ECS/container_metric_interval_upper_bound_down",
      "Description": "The upper bound of the breach size",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerMetricIntervalUpperBoundUp": {
      "Default": "SSM_BASE_PATH/ECS/container_metric_interval_upper_bound_up",
      "Description": "The upper bound of the breach size",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerMinCapacity": {
      "Default": "SSM_BASE_PATH/ECS/container_min_capacity",
      "Description": "The minimum value that Application Auto Scaling can use to scale a target during a scaling activity.",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "ContainerName": {
      "Description": "Name of the ECS Container Service",
      "Type": "String"
    },
    "CustomerName": {
      "Description": "Customer name",
      "Type": "String"
    },
    "EcsBackendElbPublicIp": {
      "Default": "SSM_BASE_PATH/ECS/ecs_backend_elb_public_ip",
      "Description": "Sensu API host",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "RedisDbTableId": {
      "Default": "SSM_BASE_PATH/ECS/redis_db_table_id",
      "Description": "Redis database (customer table id)",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "SensuApiHost": {
      "Default": "SSM_BASE_PATH/ECS/sensu_api_host",
      "Description": "Sensu API Host",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "SensuApiPort": {
      "Default": "SSM_BASE_PATH/ECS/sensu_api_port",
      "Description": "Sensu API port",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "SensuECPrimaryEndpoint": {
      "Default": "SSM_BASE_PATH/ECS/sensu_e_c_primary_endpoint",
      "Description": "Redis Host",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "SensuECPrimaryEndpointPort": {
      "Default": "SSM_BASE_PATH/ECS/sensu_e_c_primary_endpoint_port",
      "Description": "Port for Redis",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "SensuServerInputTopic": {
      "Default": "SSM_BASE_PATH/ECS/sensu_server_input_topic",
      "Description": "SNS Topic ARN",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "SensuServerSqsQueue": {
      "Default": "SSM_BASE_PATH/ECS/sensu_server_sqs_queue",
      "Description": "SQS Queue URL",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "SensuSqsMaxNumberOfMessages": {
      "Default": "SSM_BASE_PATH/ECS/sensu_sqs_max_number_of_messages",
      "Description": "Maximum number of message for SNSSQS",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "SensuSqsWaitTimeSeconds": {
      "Default": "SSM_BASE_PATH/ECS/sensu_sqs_wait_time_seconds",
      "Description": "Waiting time in second",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "TaskRoleArn": {
      "Default": "ecs_sensu_task_role",
      "Description": "Task Role ARN",
      "Type": "AWS::SSM::Parameter::Value<String>"
    },
    "VpcId": {
      "Default": "SSM_BASE_PATH/ECS/vpc_id",
      "Description": "VPC ID",
      "Type": "AWS::SSM::Parameter::Value<String>"
    }
  },
  "Resources": {
    "ContainerAlarmScaleDown": {
      "Properties": {
        "AlarmActions": [
          {
            "Ref": "ContainerScalingPolicyDown"
          }
        ],
        "AlarmDescription": {
          "Fn::Join": [
            "",
            [
              "CPU Utilization low on ",
              {
                "Ref": "ContainerName"
              },
              " container"
            ]
          ]
        },
        "ComparisonOperator": "LessThanThreshold",
        "Dimensions": [
          {
            "Name": "ServiceName",
            "Value": {
              "Ref": "ContainerName"
            }
          },
          {
            "Name": "ClusterName",
            "Value": {
              "Ref": "ContainerHost"
            }
          }
        ],
        "EvaluationPeriods": {
          "Ref": "ContainerAlarmEvaluationPeriod"
        },
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/ECS",
        "Period": {
          "Ref": "ContainerAlarmPeriod"
        },
        "Statistic": "Average",
        "Threshold": {
          "Ref": "ContainerAlarmTresholdDown"
        }
      },
      "Type": "AWS::CloudWatch::Alarm"
    },
    "ContainerAlarmScaleUp": {
      "Properties": {
        "AlarmActions": [
          {
            "Ref": "ContainerScalingPolicyUp"
          }
        ],
        "AlarmDescription": {
          "Fn::Join": [
            "",
            [
              "CPU Utilization high on ",
              {
                "Ref": "ContainerName"
              },
              " container"
            ]
          ]
        },
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "ServiceName",
            "Value": {
              "Ref": "ContainerName"
            }
          },
          {
            "Name": "ClusterName",
            "Value": {
              "Ref": "ContainerHost"
            }
          }
        ],
        "EvaluationPeriods": {
          "Ref": "ContainerAlarmEvaluationPeriod"
        },
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/ECS",
        "Period": {
          "Ref": "ContainerAlarmPeriod"
        },
        "Statistic": "Average",
        "Threshold": {
          "Ref": "ContainerAlarmTresholdUp"
        }
      },
      "Type": "AWS::CloudWatch::Alarm"
    },
    "ContainerAutoScalingTarget": {
      "DependsOn": [
        "ContainerService"
      ],
      "Properties": {
        "MaxCapacity": {
          "Ref": "ContainerMaxCapacity"
        },
        "MinCapacity": {
          "Ref": "ContainerMinCapacity"
        },
        "ResourceId": {
          "Fn::Join": [
            "",
            [
              "service/",
              {
                "Ref": "ContainerHost"
              },
              "/",
              {
                "Ref": "ContainerName"
              }
            ]
          ]
        },
        "RoleARN": {
          "Ref": "ContainerAutoscalingRole"
        },
        "ScalableDimension": "ecs:service:DesiredCount",
        "ServiceNamespace": "ecs"
      },
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget"
    },
    "ContainerScalingPolicyDown": {
      "Properties": {
        "PolicyName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "ContainerName"
              },
              "-service-autoscaling-down"
            ]
          ]
        },
        "PolicyType": "StepScaling",
        "ScalableDimension": "ecs:service:DesiredCount",
        "ScalingTargetId": {
          "Ref": "ContainerAutoScalingTarget"
        },
        "ServiceNamespace": "ecs",
        "StepScalingPolicyConfiguration": {
          "AdjustmentType": "PercentChangeInCapacity",
          "Cooldown": {
            "Ref": "ContainerCooldown"
          },
          "MetricAggregationType": "Average",
          "StepAdjustments": [
            {
              "MetricIntervalUpperBound": {
                "Ref": "ContainerMetricIntervalUpperBoundDown"
              },
              "MetricIntervalLowerBound": {
                "Ref": "ContainerMetricIntervalLowerBoundDown"
              },
              "ScalingAdjustment": {
                "Ref": "ContainerAdjustmentNumberLowDown"
              }
            },
            {
              "MetricIntervalUpperBound": {
                "Ref": "ContainerMetricIntervalLowerBoundDown"
              },
              "ScalingAdjustment": {
                "Ref": "ContainerAdjustmentNumberHighDown"
              }
            }
          ]
        }
      },
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy"
    },
    "ContainerScalingPolicyUp": {
      "Properties": {
        "PolicyName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "ContainerName"
              },
              "-service-autoscaling-up"
            ]
          ]
        },
        "PolicyType": "StepScaling",
        "ScalableDimension": "ecs:service:DesiredCount",
        "ScalingTargetId": {
          "Ref": "ContainerAutoScalingTarget"
        },
        "ServiceNamespace": "ecs",
        "StepScalingPolicyConfiguration": {
          "AdjustmentType": "PercentChangeInCapacity",
          "Cooldown": {
            "Ref": "ContainerCooldown"
          },
          "MetricAggregationType": "Average",
          "StepAdjustments": [
            {
              "MetricIntervalUpperBound": {
                "Ref": "ContainerMetricIntervalUpperBoundUp"
              },
              "MetricIntervalLowerBound": {
                "Ref": "ContainerMetricIntervalLowerBoundUp"
              },
              "ScalingAdjustment": {
                "Ref": "ContainerAdjustmentNumberLowUp"
              }
            },
            {
              "MetricIntervalLowerBound": {
                "Ref": "ContainerMetricIntervalUpperBoundUp"
              },
              "ScalingAdjustment": {
                "Ref": "ContainerAdjustmentNumberHighUp"
              }
            }
          ]
        }
      },
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy"
    },
    "ContainerService": {
      "Properties": {
        "Cluster": {
          "Ref": "ContainerHost"
        },
        "DesiredCount": {
          "Ref": "ContainerDesiredCount"
        },
        "PlacementStrategies": [
          {
            "Field": "attribute:ecs.availability-zone",
            "Type": "spread"
          },
          {
            "Field": "instanceId",
            "Type": "spread"
          }
        ],
        "ServiceName": {
          "Ref": "ContainerName"
        },
        "TaskDefinition": {
          "Ref": "ContainerTaskdefinition"
        }
      },
      "Type": "AWS::ECS::Service"
    },
    "ContainerTaskdefinition": {
      "Properties": {
        "ContainerDefinitions": [
          {
            "Name": {
              "Ref": "ContainerName"
            },
            "Image": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "ContainerImage"
                  },
                  ":",
                  {
                    "Ref": "BuildImageTag"
                  }
                ]
              ]
            },
            "Cpu": {
              "Ref": "ContainerCpu"
            },
            "Memory": {
              "Ref": "ContainerMemory"
            },
            "MemoryReservation": {
              "Ref": "ContainerMemoryReservation"
            },
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-group": "ECS-Docker",
                "awslogs-stream-prefix": {
                  "Ref": "ContainerHost"
                }
              }
            },
            "Command": [
              "server"
            ],
            "Environment": [
              {
                "Name": "API_HOST",
                "Value": {
                  "Ref": "SensuApiHost"
                }
              },
              {
                "Name": "API_PORT",
                "Value": {
                  "Ref": "SensuApiPort"
                }
              },
              {
                "Name": "TRANSPORT_NAME",
                "Value": "snssqs"
              },
              {
                "Name": "SNSSQS_MAX_NUMBER_OF_MESSAGES",
                "Value": {
                  "Ref": "SensuSqsMaxNumberOfMessages"
                }
              },
              {
                "Name": "SNSSQS_WAIT_TIME_SECONDS",
                "Value": {
                  "Ref": "SensuSqsWaitTimeSeconds"
                }
              },
              {
                "Name": "SNSSQS_REGION",
                "Value": {
                  "Ref": "AWS::Region"
                }
              },
              {
                "Name": "SNSSQS_CONSUMING_SQS_QUEUE_URL",
                "Value": {
                  "Ref": "SensuServerSqsQueue"
                }
              },
              {
                "Name": "SNSSQS_PUBLISHING_SNS_TOPIC_ARN",
                "Value": {
                  "Ref": "SensuServerInputTopic"
                }
              },
              {
                "Name": "REDIS_HOST",
                "Value": {
                  "Ref": "SensuECPrimaryEndpoint"
                }
              },
              {
                "Name": "REDIS_PORT",
                "Value": {
                  "Ref": "SensuECPrimaryEndpointPort"
                }
              },
              {
                "Name": "REDIS_DB",
                "Value": {
                  "Ref": "RedisDbTableId"
                }
              },
              {
                "Name": "ARGOS_LIVE",
                "Value": {
                  "Ref": "ArgosLive"
                }
              },
              {
                "Name": "ARGOS_SIMULATE",
                "Value": {
                  "Fn::If": [
                    "ArgosSimulateTrue",
                    "true",
                    "false"
                  ]
                }
              },
              {
                "Name": "ARGOS_URL",
                "Value": {
                  "Fn::If": [
                    "IsDevEnv",
                    "https://test-argos-eye-ext01.ws.arvato-systems.de/api/setEventData/CommonData",
                    "none"
                  ]
                }
              },
              {
                "Name": "ARGOS_API_KEY",
                "Value": {
                  "Fn::If": [
                    "IsDevEnv",
                    "FzQnaQjRtn",
                    "none"
                  ]
                }
              },
              {
                "Name": "CONTAINER_IMAGE_TAG",
                "Value": {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Ref": "ContainerImage"
                      },
                      ":",
                      {
                        "Ref": "BuildImageTag"
                      }
                    ]
                  ]
                }
              }
            ],
            "PortMappings": [
              {
                "ContainerPort": {
                  "Ref": "EcsBackendElbPublicIp"
                }
              }
            ]
          }
        ],
        "Family": {
          "Ref": "ContainerName"
        },
        "TaskRoleArn": {
          "Ref": "TaskRoleArn"
        }
      },
      "Type": "AWS::ECS::TaskDefinition"
    }
  }
}